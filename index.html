<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>MP4 → MP3 Converter</title>
<style>
body { font-family: Arial; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; background:#f0f2f5; }
form { background:white; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); width:350px; display:flex; flex-direction:column; }
input[type=file] { margin-bottom:15px; }
button { padding:10px; border:none; background:#4a90e2; color:white; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.2s; }
button:hover { background:#357ABD; }
#progressContainer { display:none; margin-top:10px; width:100%; background:#ddd; border-radius:8px; }
#progressBar { width:0%; height:20px; background:#4a90e2; border-radius:8px; transition:0.2s; }
#loading { margin-top:10px; }
</style>
</head>
<body>
<h1>MP4 → MP3 Converter</h1>
<form id="uploadForm" enctype="multipart/form-data">
<input type="file" name="file" accept=".mp4" required>
<button type="submit">Converti in MP3</button>
<div id="progressContainer">
  <div id="progressBar"></div>
</div>
<div id="loading"></div>
</form>

<script>
const form = document.getElementById("uploadForm");
const loading = document.getElementById("loading");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = form.querySelector("input[type=file]");
    if(fileInput.files.length === 0) return alert("Seleziona un file MP4");

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    loading.textContent = "Preparazione conversione...";
    progressContainer.style.display = "block";
    progressBar.style.width = "0%";

    // Invio il file e ricevo l'ID del job
    const res = await fetch("/convert", { method: "POST", body: formData });
    if(!res.ok) return alert("Upload fallito!");
    const { job_id } = await res.json();

    // SSE per il progresso
    const evtSource = new EventSource(`/progress/${job_id}`);
    evtSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        progressBar.style.width = data.percent + "%";
        loading.textContent = data.message;

        if(data.percent >= 100) {
            evtSource.close();
            // Scarica il file
            window.location = `/download/${job_id}`;
        }
    };
});
</script>
</body>
</html>